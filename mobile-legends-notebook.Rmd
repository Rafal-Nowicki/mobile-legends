---
title: "Mobile legend - cluster analysis"
author: "Rafal Nowicki"
date: "5 04 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggcorrplot)
library(magrittr)
library(knitr)
library(ggcorrplot)
library(see)
library(latex2exp)
library(car)
library(RColorBrewer) 
library(gtrendsR)
library(GGally)
library(plotly)
library(kableExtra)
```

Mobile Legends: Bang Bang is a MOBA game (Multiplayer online battle arena) for mobile devices with Android and iOS developed by Shanghai Moonton. The game was originally released in Asia on 11th of June 2016.

In the game there are 2 opposing teams consisting of 5 players each. There are around 90 champions (character) to choose from. Each character is different and may be used for different purposes depending on their skills and abillities. In that way one can distinguish mages, assasins and some more types of champions. Main task is to destroy enemies' defence towers resulting in concquering their base (yup, it's very boring but somehow very popular).

The game was getting more and more attention in Poland for a couple of years now. The graph below presents interest over time for google query "Mobile Legends" and "MOBA" in Poland. As you can see around 2017 there was a hugh increase in popularity of the game while interest in MOBA games in general was falling down gradually in past 5 years. However in March and April 2020 they experienced a rapid renaissance. We can probably associate it with a lockdown caused by COVID-19 outbreak.


```{r, echo = FALSE, message = FALSE}
results <- gtrends(c("mobile legends", "MOBA"), geo = "PL", time = "2015-01-01 2020-04-04")

res_time <- results$interest_over_time 
```

```{r, echo = FALSE, message = FALSE}
res_plot <- ggplot(res_time,aes(x = date, y = hits, col = keyword)) +
  geom_line()+
  scale_color_manual(values=c("darkred", "steelblue"))+
  ggtitle("Interest in 'Mobile Legends' and 'MOBA' in Google (Poland)") +
  theme_classic()+
  theme(legend.position = "none")
 

ggplotly(res_plot, dynamicTicks = TRUE, height = 600, width = 850) %>%
  rangeslider() %>%
  layout(hovermode = "x")
```


As stated above there are several types of characters in that game so we will try to label them based on their characteristics. In order to do so we are going to implement Principal Component Analysis to reduce dimentionallity and then k-means method to cluster them. Although the labels are known such an analysis may be helpful for maintaining characters' skill sets in a balance way.

## Data description
First of all let's have a look on how our data looks like. In the table below you can find all characters in alphabetical order. 

One important remark is although the list below present all playable characters right now we are going to consider it as sample since the characters' set is being constantly updated with new characters - in that way statistical inference can be justified.

```{r, echo = FALSE}
df <- read.csv("df_ml_story.csv") %>%
  as_tibble() %>%
  select(-c(3,7,13)) %>%
  arrange(HERO)

kable(df) %>% 
  kable_styling(fixed_thead = T) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

One important thing we should be interested in is the variability of champions characteristics. Below you can see the coefficient of variation (in %).

```{r, echo = F}
df_mean <- summarise_if(df, is.numeric, mean)

df_sd <- summarize_if(df, is.numeric, sd)

kable(round((df_sd/df_mean*100),2)) %>%
   kable_styling()
```

The variabiliy of *mana* and *mana regeneration* exeeds 50% whereas for *health points regeneration* and *armor* it's about 20%. We will have to check the data for outliers as those values might be inflated for instance just by a single observation. Rest of the variables vary just a bit (under 10%). The value for magic resistance is constant for every character so we are going to drop that variable in further analysis.


Now let's look for some possible relationships and check distributions of the variables.

```{r, message= F, warning=F, echo = F}
df <- select(df, -"MGC_DFN") %>%
  mutate(HP = HP/1000)
  

p <- ggpairs(data=df, columns=2:9, 
             lower = list(continuous = wrap("points",alpha = 0.5, size=0.5, col = "steelblue")),
  diag = list(continuous = wrap("densityDiag", fill = "darkred", alpha = 0.8)))+
  theme_classic()

ggplotly(p, height = 800, width = 850)
```



We can see some relationships - f.e. *mana* vs. *mana regeneration* and *health points* vs. *armor* and many more - we are going to investigate them soon. 

There are some outliers - note a champion whose *health point regeneration* ability is almost 3 times more powerful than the mean for the sample. We can also see a champion whose *health points* ability is about 2 times weaker than the average. Let's find out who are those people.

```{r, echo = FALSE }
df[c(which.max(df$HP_RGN), which.min(df$HP)), ] %>%
  kable() %>%
  kable_styling()
```


For the sake of analysis we are going to remove both of them from our "sample".

Density functions for variables like movement speed, mana and mana regenerations seem to be bimodal - it is clear sign there are some subpopulations in our "sample" so it is reasonable to conduct cluster analysis.



We can check the correlations and their significance - just for fun since *Simson paradox* might be present. 

```{r, echo = FALSE}
df_num <- df[-c(which.max(df$HP_RGN), which.min(df$HP)),-c(1,10,11)]
correlations <- cor(df_num)
p_mat <- cor_pmat(df_num)

ggcorrplot(correlations, hc.order = TRUE, type = "lower", lab = TRUE, digits = 1,
           p.mat = p_mat, ggtheme = ggplot2::theme_classic, sig.level = 0.001,
           colors = c("steelblue", "white", "darkred"),
           title = "Pearson's correlation matrix", legend.title = latex2exp :: TeX("$\\rho$ value"),)

```

